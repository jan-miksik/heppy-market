# Service-only Worker: do NOT add routes. Access only via Cloudflare Pages Service Binding.
# No custom domain, no workers.dev exposure â€” keeps the API internal and more secure.
name = "dex-trading-agents-api"
# Built from monorepo root so node_modules and @dex-agents/shared resolve (see build command)
main = "dist/worker.js"
compatibility_date = "2026-02-12"
compatibility_flags = ["nodejs_compat"]

# Build from repo root so all dependencies and workspace packages resolve
[build]
command = "npm run build:worker"
cwd = "../.."

# Local dev: uses local D1 and KV. Production: use [env.production] and deploy with --env production
# Cloudflare free plan allows max 5 cron triggers per Worker
[triggers]
crons = [
  "*/5 * * * *",   # 5m
  "*/15 * * * *",  # 15m
  "0 * * * *",     # 1h
  "0 */4 * * *",   # 4h
  "0 0 * * *"      # 1d
]

[[d1_databases]]
binding = "DB"
database_name = "trading-agents"
database_id = "local-trading-agents"
migrations_dir = "src/db/migrations"

[[kv_namespaces]]
binding = "CACHE"
id = "local-cache"

[durable_objects]
bindings = [
  { name = "TRADING_AGENT", class_name = "TradingAgentDO" },
  { name = "AGENT_MANAGER", class_name = "AgentManagerDO" }
]

# Free plan requires SQLite-backed DOs (new_sqlite_classes)
[[migrations]]
tag = "v1"
new_sqlite_classes = ["TradingAgentDO", "AgentManagerDO"]

# Production: create D1 + KV in dashboard, then set database_id and id below. Deploy with: wrangler deploy --env production
[env.production]
name = "dex-trading-agents-api"
# Replace with your production D1 database_id (from: wrangler d1 list)
[[env.production.d1_databases]]
binding = "DB"
database_name = "trading-agents"
database_id = "0331580c-2b26-4fa1-a35f-57af26e9ea6b"
migrations_dir = "src/db/migrations"
# Replace with your production KV namespace id (from: wrangler kv namespace list)
# Create one with: wrangler kv namespace create CACHE
[[env.production.kv_namespaces]]
binding = "CACHE"
id = "b056ff9b5da14b23b8f4a5076038b783"
[env.production.durable_objects]
bindings = [
  { name = "TRADING_AGENT", class_name = "TradingAgentDO" },
  { name = "AGENT_MANAGER", class_name = "AgentManagerDO" }
]
[[env.production.migrations]]
tag = "v1"
new_sqlite_classes = ["TradingAgentDO", "AgentManagerDO"]
